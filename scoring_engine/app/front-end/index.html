
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Scoring Engine</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  </head>
  <body>
    <section class="section">
      <div class="container">
        <h1 class="title">
          <i class="fas fa-rocket"></i> Scoring Engine
        </h1>
      </div>
    </section>
    <div id="chart" class="section">
    </div>
  </body>
</html>

<script>
  // options for scoring engine chart
  var options = {
    chart: {
      height: 430,
      type: 'bar',
    },
    plotOptions: {
      bar: {
        horizontal: true,
        dataLabels: {
          position: 'top',
        },
      }
    },
    dataLabels: {
      enabled: true,
      offsetX: -6,
      style: {
        fontSize: '12px',
        colors: ['#fff']
      }
    },
    stroke: {
      show: true,
      width: 1,
      colors: ['#fff']
    },
    series: [
        //{
        //  name: "Team 1",
        //  data: [3, 8]
        //}
    ],
    xaxis: {
      categories: [],
    },
  }


var pollAPI = async function() {
    const response = await fetch(document.location.href + "api/v1/service_registry");
    const myJson = await response.json();

    var kinds = new Set();
    var teams = new Object();

    for (let [key, value] of Object.entries(myJson.services)) {
        value.forEach(function(value) {
            kinds.add(value.kind)
        })
        teams[key] = new Array();
    }

    for (let [teamName, points] of Object.entries(teams)) {
        kinds.forEach(function(kind){
            myJson.services[teamName].forEach(function(service){
                if (service.kind == kind) {
                    points.push(service.points)
                }
            })
        })
    }

    options.xaxis = Array.from(kinds);
    var newSeries = new Array();

    for (let [teamName, points] of Object.entries(teams)) {
        newSeries.push({
            name: teamName,
            data: points
        })
    }

    return chart.updateOptions({
        xaxis: {
            categories: Array.from(kinds),
        },
        series: newSeries
    }, false, true, true)
}

setInterval(function() {
    console.log("Polling API for information")
    pollAPI()
}, 60 * 1000);

var chart = new ApexCharts(
  document.querySelector("#chart"),
  options
);

pollAPI()

chart.render();
</script>
